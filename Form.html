<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Expense - Expense System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <!-- AIRTABLE API -->
    <script src="api.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .form-header {
            background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        .btn-submit {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 12px 30px;
            font-weight: 600;
            border: none;
            border-radius: 5px;
        }
        .info-box {
            background: #e8f4fc;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .file-input-custom::-webkit-file-upload-button {
            visibility: hidden;
        }
        .file-input-custom::before {
            content: 'Choose file';
            display: inline-block;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 12px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status">
        <div class="alert alert-sm mb-0" id="onlineStatus" style="display: none;">
            <i class="bi bi-wifi"></i> <span id="statusText">Online</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background: linear-gradient(135deg, #2c3e50 0%, #1a2530 100%);">
        <div class="container">
            <a class="navbar-brand" href="Dashboard.html">
                <i class="bi bi-wallet2"></i> Expense System
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="Dashboard.html"><i class="bi bi-house-door"></i> Home</a>
                <a class="nav-link active" href="Form.html"><i class="bi bi-plus-circle"></i> Submit</a>
                <a class="nav-link" href="Approval.html"><i class="bi bi-check-circle"></i> Approve</a>
                <a class="nav-link" href="Payment.html"><i class="bi bi-credit-card"></i> Pay</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <!-- Header -->
            <div class="form-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>Expense Request Form</h2>
                        <p class="mb-0">Please fill out all required fields below</p>
                    </div>
                    <div class="text-end">
                        <small class="d-block" id="formStatus">Ready to submit</small>
                        <small class="d-block" id="dataSource">Loading...</small>
                    </div>
                </div>
            </div>
            
            <!-- Approval Flow Info -->
            <div class="info-box">
                <h6><i class="bi bi-info-circle"></i> Approval Flow</h6>
                <p class="mb-0 small">Request ‚Üí <strong>Sub Approval (Manager)</strong> ‚Üí Main Approval (Achmad Oskar) ‚Üí Payment (Financing)</p>
            </div>
            
            <!-- Employee Information -->
            <div class="mb-4">
                <h5>Employee Information</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Full Name</label>
                        <input type="text" class="form-control" id="employeeName" placeholder="Enter your full name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Division/Department</label>
                        <select class="form-select" id="division" required onchange="updateManagers()">
                            <option value="">Select Division</option>
                            <option value="Service Delivery">Service Delivery</option>
                            <option value="Product Development">Product Development</option>
                            <option value="Business Administration">Business Administration</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label required">Manager's Name (Approval)</label>
                        <select class="form-select" id="managerName" required>
                            <option value="">Select Manager</option>
                            <option value="Muhammad Salman">Muhammad Salman - Sub Approval</option>
                            <option value="Mohammad Rizki">Mohammad Rizki - Sub Approval</option>
                            <option value="Laras Setyowinanti">Laras Setyowinanti - Sub Approval</option>
                            <option value="Achmad Oskar Wiriadidjaja">Achmad Oskar Wiriadidjaja - Direct Approval (Skip Sub-Approval)</option>
                        </select>
                        <div class="form-text">
                            <strong>Choose one option:</strong><br>
                            1. <strong>Sub-approvers (Salman, Rizki, Laras)</strong> ‚Üí will go through 2 stages of approval<br>
                            2. <strong>Achmad Oskar</strong> ‚Üí goes directly to the main approval (skip sub-approval)
                        </div>
                    </div>
                </div>
            
            <!-- Expense Details -->
            <div class="mb-4">
                <h5>Expense Details</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Expense Date</label>
                        <input type="date" class="form-control" id="date" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Expense Type</label>
                        <select class="form-select" id="type" required>
                            <option value="">Select Type</option>
                            <option value="cash-advance">Cash Advance</option>
                            <option value="reimbursement">Reimbursement</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Expense Category</label>
                        <select class="form-select" id="expenseCategory" required>
                            <option value="">Select Category</option>
                            <option value="travel">Travel & Accommodation</option>
                            <option value="meals">Meals & Entertainment</option>
                            <option value="office-supplies">Office Supplies</option>
                            <option value="software">Software & Subscriptions</option>
                            <option value="hardware">Hardware & Equipment</option>
                            <option value="training">Training & Development</option>
                            <option value="marketing">Marketing & Advertising</option>
                            <option value="utilities">Utilities & Services</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Project/Item Name</label>
                        <input type="text" class="form-control" id="project" placeholder="e.g., Client Meeting, Software License" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label required">Expense Description</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="Describe the purpose of this expense..." required></textarea>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label required">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">Rp</span>
                            <input type="number" class="form-control" id="amount" step="0.01" min="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attachments -->
            <div class="mb-4">
                <h5>Attachment</h5>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Payment Proof / Receipt</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="attachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="previewFileName(this)">
                            <label class="input-group-text" for="attachment">
                                <i class="bi bi-paperclip"></i>
                            </label>
                        </div>
                        <div class="form-text">
                            Upload the proof of payment (maximum 5 MB). Accepted formats: PDF, JPG, PNG, DOC.<br>
                            <span id="fileNamePreview" class="text-muted small"></span>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="noAttachment">
                            <label class="form-check-label" for="noAttachment">
                                Proof of payment is currently unavailable
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Method -->
            <div class="mb-4">
                <h5>Payment Information</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Preferred Payment Method</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="bank-transfer">Bank Transfer</option>
                            <option value="payroll">Payroll Deduction</option>
                            <option value="virtual-account">Virtual Account</option>
                            <option value="e-wallet">E-Wallet</option>
                            <option value="cash">Cash</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Urgency Level</label>
                        <select class="form-select" id="urgency" required>
                            <option value="normal">Normal (Process within 14 days)</option>
                            <option value="urgent">Urgent (Process within 7 days)</option>
                            <option value="critical">Critical (Process within 3 days)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='Dashboard.html'">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </button>
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="saveAsDraft()">
                        <i class="bi bi-save"></i> Save as Draft
                    </button>
                    <button type="button" class="btn btn-submit" onclick="submitForm()">
                        <i class="bi bi-paper-plane"></i> Submit for Approval
                    </button>
                </div>
            </div>
            
            <!-- Debug Section -->
            <div class="mt-4 pt-4 border-top">
                <h6>Debug Tools</h6>
                <button class="btn btn-sm btn-warning" onclick="checkLocalStorage()">
                    <i class="bi bi-database"></i> Check Storage
                </button>
                <button class="btn btn-sm btn-info" onclick="autoFillForm()">
                    <i class="bi bi-magic"></i> Auto-fill Test Data
                </button>
                <button class="btn btn-sm btn-success" onclick="testAirtableConnection()">
                    <i class="bi bi-wifi"></i> Test Airtable
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
// Global variables
const validSubApprovers = ['Muhammad Salman', 'Mohammad Rizki', 'Laras Setyowinanti'];
const mainApprover = 'Achmad Oskar Wiriadidjaja';
let isOnline = false;

// Initialize form when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Form page loaded - Airtable Version');
    
    // Update navigation active state
    const currentPage = window.location.pathname.split('/').pop();
    document.querySelectorAll('.nav-link').forEach(link => {
        if (link.getAttribute('href') === currentPage) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
        
   // Set today's date as default
    const dateField = document.getElementById('date');
    if (dateField) {
        dateField.valueAsDate = new Date();
    }
    
    // Initialize manager dropdown
    updateManagers();
    
    // Check Airtable connection
    testAirtableConnection();
    
    // Load test data if URL has test parameter
    if (window.location.search.includes('test=true')) {
        autoFillForm();
    }
});

// Update function to show all managers
function updateManagers() {
    const division = document.getElementById('division').value;
    const managerSelect = document.getElementById('managerName');
    
    // Clear existing options
    managerSelect.innerHTML = '<option value="">Select Manager</option>';
    
    // Always show all sub-approvers regardless of division
    validSubApprovers.forEach(manager => {
        const option = document.createElement('option');
        option.value = manager;
        option.textContent = `${manager} - Sub Approval`;
        managerSelect.appendChild(option);
    });
    
    // Add main approver as option
    const mainOption = document.createElement('option');
    mainOption.value = mainApprover;
    mainOption.textContent = `${mainApprover} - Direct Approval (Skip Sub-Approval)`;
    managerSelect.appendChild(mainOption);
}

async function testAirtableConnection() {
    try {
        document.getElementById('formStatus').textContent = 'Testing Airtable connection...';
        document.getElementById('dataSource').textContent = 'Checking...';
        
        const testData = await window.airtableService.getAllExpenses();
        isOnline = true;
        
        document.getElementById('formStatus').textContent = 'Ready to submit';
        document.getElementById('dataSource').textContent = `Airtable Connected (${testData.length} records)`;
        
        // Update status indicator
        const statusDiv = document.getElementById('onlineStatus');
        statusDiv.className = 'alert alert-sm alert-success mb-0';
        statusDiv.style.display = 'block';
        document.getElementById('statusText').textContent = 'Airtable Online';
        
        console.log('‚úÖ Airtable connection successful');
        return true;
        
    } catch (error) {
        isOnline = false;
        
        document.getElementById('formStatus').textContent = 'Ready (Offline Mode)';
        document.getElementById('dataSource').textContent = 'Using local storage';
        
        // Update status indicator
        const statusDiv = document.getElementById('onlineStatus');
        statusDiv.className = 'alert alert-sm alert-warning mb-0';
        statusDiv.style.display = 'block';
        document.getElementById('statusText').textContent = 'Airtable Offline - Using Local';
        
        console.log('‚ö†Ô∏è Airtable connection failed, using localStorage');
        return false;
    }
}

async function submitForm() {
    if (!validateForm()) {
        alert('Please fill all required fields correctly!');
        return;
    }
    
    const manager = document.getElementById('managerName').value;
    const validManagers = [...validSubApprovers, mainApprover];
    
    if (!validManagers.includes(manager)) {
        alert('Please select a valid approver.');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('.btn-submit');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Submitting...';
    submitBtn.disabled = true;
    
    try {
        // Determine approval flow based on selected manager
        let approvalFlow = [];
        let nextStatus = '';
        
        if (manager === mainApprover) {
            // Direct to main approval (skip sub-approval)
            approvalFlow = ['Submitted', 'Pending Main Approval'];
            nextStatus = 'pending-main';
        } else {
            // Normal flow with sub-approval first
            approvalFlow = ['Submitted', 'Pending Sub-Approval', 'Pending Main Approval'];
            nextStatus = 'pending';
        }
        
        // Handle file attachment
        const fileInput = document.getElementById('attachment');
        let hasAttachment = false;
        
        if (!document.getElementById('noAttachment').checked && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size exceeds 5MB limit. Please compress or choose a smaller file.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }
            
            hasAttachment = true;
        }
        
        // Create expense object
        const expenseData = {
            date: document.getElementById('date').value,
            name: document.getElementById('employeeName').value,
            division: document.getElementById('division').value,
            manager: manager,
            type: document.getElementById('type').value,
            category: document.getElementById('expenseCategory').value,
            project: document.getElementById('project').value,
            description: document.getElementById('description').value,
            amount: parseFloat(document.getElementById('amount').value),
            paymentMethod: document.getElementById('paymentMethod').value,
            urgency: document.getElementById('urgency').value,
            hasAttachment: hasAttachment,
            status: nextStatus,
            approvalFlow: approvalFlow,
            paymentStatus: 'pending',
            submittedDate: new Date().toISOString(),
            lastUpdated: new Date().toISOString()
        };
        
        console.log('Submitting expense to Airtable:', expenseData);
        
        // Kirim ke Airtable
        const result = await window.airtableService.createExpense(expenseData);
        
        if (result.success) {
            let message = `‚úÖ Expense Submitted Successfully!\n\n` +
                  `ID: ${result.recordId}\n` +
                  `Employee: ${expenseData.name}\n` +
                  `Project: ${expenseData.project}\n` +
                  `Amount: Rp ${expenseData.amount.toLocaleString('id-ID')}\n` +
                  `Approver: ${expenseData.manager}\n`;
            
            if (manager === mainApprover) {
                message += `\nüìã Approval Flow: Direct to Main Approval\n` +
                           `Status: Pending Main Approval (Achmad Oskar)\n` +
                           `Next: Achmad Oskar ‚Üí Financing`;
            } else {
                message += `\nüìã Approval Flow: 2-Step Process\n` +
                           `Status: Pending Sub-Approval\n` +
                           `Next: ${expenseData.manager} ‚Üí Achmad Oskar ‚Üí Financing`;
            }
            
            message += `\n\nüìé Attachment: ${expenseData.hasAttachment ? 'Uploaded' : 'None'}`;
            message += `\nüåê Status: ${isOnline ? 'Saved to Airtable' : 'Saved locally (offline)'}`;
            
            alert(message);
            
            // Clear form
            const form = document.querySelector('form');
            if (form) {
                form.reset();
            }
            document.getElementById('date').valueAsDate = new Date();
            
            // ‚úÖ REDIRECT KE APPROVAL.HTML (bukan Dashboard)
            setTimeout(() => {
                if (manager === mainApprover) {
                    // Direct to main approval
                    window.location.href = 'Approval.html?role=main-approval';
                } else {
                    // Need sub approval
                    window.location.href = 'Approval.html?role=sub-approval';
                }
            }, 1000);
            
        } else {
            alert(`‚ö†Ô∏è Submitted with fallback\n\nExpense saved locally. Airtable error: ${result.error}\n\nYou can continue working offline.`);
            
            // Clear form
            const form = document.querySelector('form');
            if (form) {
                form.reset();
            }
            document.getElementById('date').valueAsDate = new Date();
            
            // ‚úÖ REDIRECT KE APPROVAL.HTML (bukan Dashboard)
            setTimeout(() => {
                if (manager === mainApprover) {
                    window.location.href = 'Approval.html?role=main-approval';
                } else {
                    window.location.href = 'Approval.html?role=sub-approval';
                }
            }, 1000);
        }
        
    } catch (error) {
        console.error('Error submitting form:', error);
        alert('‚ùå Error submitting expense. Please try again.');
        
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function validateForm() {
    const requiredFields = [
        'employeeName', 'division', 'managerName', 'date', 
        'type', 'expenseCategory', 'project', 'description', 'amount', 'paymentMethod'
    ];
    
    for (let fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            return false;
        } else {
            field.classList.remove('is-invalid');
        }
    }
    
    // Validate amount
    const amount = document.getElementById('amount').value;
    if (!amount || parseFloat(amount) <= 0) {
        document.getElementById('amount').classList.add('is-invalid');
        return false;
    }
    
    // Validate manager
    const manager = document.getElementById('managerName').value;
    const validManagers = [...validSubApprovers, mainApprover];
    
    if (!validManagers.includes(manager)) {
        alert('Please select a valid approver.');
        document.getElementById('managerName').classList.add('is-invalid');
        return false;
    }
    
    return true;
}

function saveAsDraft() {
    const draftData = {
        id: 'draft-' + Date.now(),
        name: document.getElementById('employeeName').value || '',
        project: document.getElementById('project').value || '',
        amount: document.getElementById('amount').value || '',
        date: document.getElementById('date').value || new Date().toISOString().split('T')[0],
        manager: document.getElementById('managerName').value || '',
        savedDate: new Date().toISOString()
    };
    
    let drafts = JSON.parse(localStorage.getItem('expenseDrafts') || '[]');
    drafts.push(draftData);
    localStorage.setItem('expenseDrafts', JSON.stringify(drafts));
    
    alert('Draft saved successfully to local storage!');
}

function checkLocalStorage() {
    const submissions = JSON.parse(localStorage.getItem('expenseSubmissions') || '[]');
    const drafts = JSON.parse(localStorage.getItem('expenseDrafts') || '[]');
    
    alert(`LocalStorage Status:\n\n` +
          `Submitted Expenses: ${submissions.length} items\n` +
          `Drafts: ${drafts.length} items\n` +
          `Connection: ${isOnline ? 'Online (Airtable)' : 'Offline (Local)'}\n\n` +
          `Latest Draft: ${drafts.length > 0 ? drafts[drafts.length-1].project : 'None'}`);
}

// Add helper function for file preview
function previewFileName(input) {
    const fileNamePreview = document.getElementById('fileNamePreview');
    if (input.files.length > 0) {
        const file = input.files[0];
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
        fileNamePreview.textContent = `Selected: ${file.name} (${fileSize} MB)`;
        
        // Uncheck "no attachment" if file is selected
        document.getElementById('noAttachment').checked = false;
    } else {
        fileNamePreview.textContent = '';
    }
}

function autoFillForm() {
    // Random division
    const divisions = ['Service Delivery', 'Product Development', 'Business Administration'];
    const randomDivision = divisions[Math.floor(Math.random() * divisions.length)];
    
    // Random manager (50% chance for main approver)
    const useMainApprover = Math.random() > 0.5;
    let randomManager;
    
    if (useMainApprover) {
        randomManager = mainApprover;
    } else {
        randomManager = validSubApprovers[Math.floor(Math.random() * validSubApprovers.length)];
    }
    
    document.getElementById('employeeName').value = 'John Doe';
    document.getElementById('division').value = randomDivision;
    
    // Update managers dropdown first
    updateManagers();
    
    // Set manager after a small delay to ensure dropdown is updated
    setTimeout(() => {
        document.getElementById('managerName').value = randomManager;
    }, 100);
    
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    document.getElementById('type').value = 'reimbursement';
    document.getElementById('expenseCategory').value = 'meals';
    document.getElementById('project').value = 'Client Meeting';
    document.getElementById('description').value = 'Business lunch with important client';
    document.getElementById('amount').value = '500000';
    document.getElementById('paymentMethod').value = 'bank-transfer';
    document.getElementById('urgency').value = 'normal';
    
    // Random attachment
    if (Math.random() > 0.5) {
        document.getElementById('noAttachment').checked = false;
        document.getElementById('fileNamePreview').textContent = 'Selected: receipt.jpg (1.23 MB)';
    } else {
        document.getElementById('noAttachment').checked = true;
    }
    
    alert(`Test data filled!\nDivision: ${randomDivision}\nManager: ${randomManager}\n\nClick "Submit for Approval" to test.`);
}
</script>

</body>
</html>